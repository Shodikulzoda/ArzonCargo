@page "/"
@using ReferenceClass.Models
@inject HttpClient Http

@using MudBlazor

<style>
    .table-wrapper {
        background-color: #fdfdfd;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin: 40px auto;
        max-width: 1000px;
    }

    .mud-table {
        border-radius: 10px;
        overflow: hidden;
    }

    .mud-table thead {
        background-color: #1976d2; /* MudBlazor Primary color */
        color: white;
        font-weight: bold;
    }

    .mud-table td {
        padding: 12px;
    }

    .pagination-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }

    .pagination-buttons .mud-button {
        min-width: 120px;
        border-radius: 8px;
    }

    .page-indicator {
        font-weight: bold;
        font-size: 1.1rem;
    }
</style>

<div class="table-wrapper">

    <MudTable Items="Users" Class="mud-table" Striped="true" Hover="true" Bordered="true" Dense="true">
        <HeaderContent>
            <MudTh>Id</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Address</MudTh>
            <MudTh>Phone</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Id">@context.Id</MudTd>
            <MudTd DataLabel="Name">@context.Name</MudTd>
            <MudTd DataLabel="Address">@context.Address</MudTd>
            <MudTd DataLabel="Phone">@context.Phone</MudTd>
        </RowTemplate>
    </MudTable>

    <div class="pagination-buttons">
        <MudButton OnClick="Decrement" Color="Color.Secondary" Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.ArrowBack" Disabled="@(CurrentPage == 1)">
            Back
        </MudButton>

        <MudText Class="page-indicator">@CurrentPage - @TotalPages</MudText>

        <MudButton OnClick="Increment" Color="Color.Primary" Variant="Variant.Filled"
                   EndIcon="@Icons.Material.Filled.ArrowForward" Disabled="@(CurrentPage == TotalPages)">
            Next
        </MudButton>
    </div>

</div>

@code {
    public IEnumerable<User> Users { get; set; } = [];
    public UserDto? UserDto = new();

    private int CurrentPage = 1;
    private int TotalPages = 1;
    private int PageSize = 10;
    private bool IsLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await ShowPage();
    }

    private async Task Increment()
    {
        if (!IsLoading && CurrentPage < TotalPages)
        {
            CurrentPage++;
            await ShowPage();
        }
    }

    private async Task Decrement()
    {
        if (!IsLoading && CurrentPage > 1)
        {
            CurrentPage--;
            await ShowPage();
        }
    }

    public async Task ShowPage()
    {
        IsLoading = true;

        try
        {
            string url = $"http://localhost:5191/User/UserPagination?Page={CurrentPage}&PageSize={PageSize}";

            UserDto = await Http.GetFromJsonAsync<UserDto>(url);

            if (UserDto?.Users != null)
            {
                Users = UserDto.Users.ToList();

                int totalCount = UserDto.TotalCount;
                TotalPages = totalCount > 0
                    ? (int)Math.Ceiling((double)totalCount / PageSize)
                    : 1;

                if (CurrentPage > TotalPages)
                {
                    CurrentPage = TotalPages;
                }
            }
            else
            {
                Users = [];
                TotalPages = 1;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            Users = [];
            TotalPages = 1;
        }
        finally
        {
            IsLoading = false;
        }
    }

}